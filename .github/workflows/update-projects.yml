name: Update Projects

   on:
     repository_dispatch:
       types: [new_readme_received]

   permissions:
     contents: write

   jobs:
     update:
       runs-on: ubuntu-latest
       steps:
         - name: Checkout repository
           uses: actions/checkout@v4
           with:
             ref: main
             token: ${{ secrets.GITHUB_TOKEN }}

         - name: Configure Git
           run: |
             git config user.name "github-actions[bot]"
             git config user.email "github-actions[bot]@users.noreply.github.com"

         - name: Update project data
           run: |
             mkdir -p data/projects
             
             PROJECT_FILE="data/projects/${{ github.event.client_payload.repo }}.json"
             
             cat > "$PROJECT_FILE" << 'EOF'
             {
               "name": "${{ github.event.client_payload.repo }}",
               "owner": "${{ github.event.client_payload.owner }}",
               "url": "${{ github.event.client_payload.html_url }}",
               "readme": ${{ toJson(github.event.client_payload.readme) }},
               "updated_at": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
             }
             EOF
             
             echo "✅ Created/updated: $PROJECT_FILE"

         - name: Commit and push to main
           run: |
             git add data/projects/
             
             if git diff --staged --quiet; then
               echo "ℹ️ No changes detected, skipping commit"
               exit 0
             fi
             
             git commit -m "Update project: ${{ github.event.client_payload.repo }}"
             git push origin main
             
             echo "✅ Changes pushed to main branch"